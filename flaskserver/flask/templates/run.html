{% extends "base.html" %}
{% block head %}
<!--  
    Handle the running of one script.  Passed parameters are:
        pid = the identifier of the running process
        scriptname = the name of the file that was run
-->
<title>{{scriptname}} - Output</title>
{% endblock head %}

{% block body %}

<h2>Output from: {{scriptname}}</h2>

<iframe id='output_frame' src='/output/{{pid}}' style='width: 600px; height: 300px'></iframe> 

<h3>Is script still running?</h3>

<!--TODO: Make this look nice -->
<div id='still_running' style='font-weight: bold; font-size: 20px'></div>

<script>
function check_reload() {
    // Wait for a specified time then reload the output iframe
    TIME_OUT_MILLIS = 1000
    window.setTimeout("load_output()", TIME_OUT_MILLIS)
}

function load_output() {
    // Update the output in the iframe
    // TODO:  Change to xmlhttp to load the output and handle the race condition for the last output
    iframe = document.getElementById('output_frame')
    original_output = iframe.contentDocument.body.innerHTML
    if (is_process_running()) {
        new_output = get_output()
        iframe.contentDocument.body.innerHTML = new_output
        check_reload()
        //TODO:  Move the frame to the last line
    }
}

function get_output() {
    // load the output for this pid from the server
    xmlhttp=new XMLHttpRequest();
    xmlhttp.open("GET", "/output/{{pid}}", false); //false = synchronous request
    xmlhttp.send();
    return xmlhttp.responseText
}

function is_process_running() {
    //Query the server to ask if the pid this page is looking at is still running
    // Not going to try to support IE6 or earlier

    
    xmlhttp=new XMLHttpRequest();
    xmlhttp.open("GET", "/isrunning/{{pid}}", false); //false = synchronous request
    xmlhttp.send();
    document.getElementById('still_running').innerHTML = xmlhttp.responseText
    return (xmlhttp.responseText == 'yes')
}

// Set up the window onload function
window.onload=check_reload

</script>
{% endblock body %}